# ARTeMon

**AksTis Router Temp Monitor**

Мониторинг температуры процессора роутера с записью логов на USB

## Описание

Скрипт измеряет температуру процессора роутера с заданным интервалом (по умолчанию 1 минута), сохраняя данные в RAM. После чего, с заданным интервалом (по умолчанию 1 час) переносит данные из RAM на USB, вычисляя минимальную, максимальную и среднюю температуру за этот период с выводом в системный журнал веб-интерфейса роутера.  
При превышении заданного порога температуры (по умолчанию 60°C) также выводит предупреждение в системный журнал.  
Логи за предыдущий месяц автоматически архивируются в .gz на USB

Разработан для роутера на прошивке AsusWRT основанной на BusyBox

Испытан на AsusWRT 3.0.0.4.388_33903 с BusyBox v1.25.1

## Зависимости
BusyBox с awk, basename, cat, cut, date, df, echo, grep, gzip, head, logger, mkdir, pidof, printf, sleep, sort, tail, wc

## Как использовать

### Установка

1. Подключитесь к роутеру по SSH
2. Поместите скрипт в файл /jffs/scripts/artemon.sh
   - Откройте файл для редактирования с помощью vi
   - vi /jffs/scripts/artemon.sh
   - Нажмите i, чтобы войти в режим вставки
   - Скопируйте весь текст скрипта и вставьте его в терминал
   - Нажмите Esc, чтобы выйти из режима вставки
   - Введите :wq и нажмите Enter, чтобы сохранить файл и закрыть vi

3. Сделайте скрипт исполняемым с помощью команды:
   - chmod +x /jffs/scripts/artemon.sh

4. Выполните скрипт вручную для проверки:
   - /jffs/scripts/artemon.sh &
5. Проверьте системный журнал:
   - Зайдите в веб-интерфейс роутера (обычно http://192.168.0.1), перейдите в System Log и найдите записи с тегом ARTeMon

### Запуск
```
./artemon.sh [interval_temp] [interval_log] [temp_alarm] [--debug|-d] &
./artemon.sh [interval_temp] [--interactive|-i]
```
**interval_temp** - интервал меджу замерами температуры (по умолчанию 1 минута)

**interval_log** - интервал с которым скрипт пишет лог на USB и выводит в системный журнал веб-интерфейса роутера минимальную, максимальную и среднюю температуру (по умолчанию 1 час)

**temp_alarm** - температура при превышении которой, скрипт выводит предупреждение в системный журнал (по умолчанию 60°C)

**--debug, -d** - режим отладки

**--interactive, -i** - интерактивный режим

### Примеры

**Нормальный режим работы.** Сообщения с температурой выводятся в системный журнал веб интерфейса роутера

+ Замеры каждые 60 сек, копирование на USB каждые 3600 сек, тревога при 60°C, знак & запускает скрипт в фоновом режиме
```
./artemon.sh &
```

+ Замеры каждые 45 сек, копирование на USB каждые 3000 сек, тревога при 70°C, знак & запускает скрипт в фоновом режиме
```
./artemon.sh 45 3000 70 &
```

**Режим отладки.** Сообщения с температурой выводятся в системный журнал веб интерфейса роутера. Сообщает в консоль о каждом своём действии.

+ Замеры каждые 30 сек, копирование на USB каждые 300 сек, тревога при 50°C, вывод отладки в консоль
```
./artemon.sh 30 300 50 -d
```

**Интерактивный режим.** Ничего не выводит в системный журнал. Показания температуры выводятся в консоль

+  Замеры каждые 10 сек, вывод в консоль
```
./artemon.sh 10 -i
```

+  Замеры каждые 60 сек, вывод в консоль
```
./artemon.sh -i
```

## Проблемы

Известными методами не получилось добавить скрипт в автозагрузку на роутере Asus. Неизвестными методами тоже не получилось добавить скрипт в автозагрузку. 

Стоковая прошивка роутера Asus (3.0.0.4.388_33903) настолько сильно урезана, что даже базовые методы вроде nohup не спасают.

Поэтому скрипт работает только пока запущена ssh-сессия.

## Варианты решения проблем

Внешний запуск например с помощью Raspberry Pi:

```
#!/bin/bash
while true; do
    ssh admin@192.168.0.1 "ps | grep artemon.sh | grep -v grep || /jffs/scripts/artemon.sh &"
    sleep 60
done
```
